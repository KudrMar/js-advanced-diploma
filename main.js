(()=>{"use strict";class e{constructor(){this.boardSize=8,this.container=null,this.boardEl=null,this.cells=[],this.cellClickListeners=[],this.cellEnterListeners=[],this.cellLeaveListeners=[],this.newGameListeners=[],this.saveGameListeners=[],this.loadGameListeners=[]}bindToDOM(e){if(!(e instanceof HTMLElement))throw new Error("container is not HTMLElement");this.container=e}drawUi(e){this.checkBinding(),this.container.innerHTML='\n      <div class="controls">\n        <button data-id="action-restart" class="btn">New Game</button>\n        <button data-id="action-save" class="btn">Save Game</button>\n        <button data-id="action-load" class="btn">Load Game</button>\n      </div>\n      <div class="board-container">\n        <div data-id="board" class="board"></div>\n      </div>\n    ',this.newGameEl=this.container.querySelector("[data-id=action-restart]"),this.saveGameEl=this.container.querySelector("[data-id=action-save]"),this.loadGameEl=this.container.querySelector("[data-id=action-load]"),this.newGameEl.addEventListener("click",(e=>this.onNewGameClick(e))),this.saveGameEl.addEventListener("click",(e=>this.onSaveGameClick(e))),this.loadGameEl.addEventListener("click",(e=>this.onLoadGameClick(e))),this.boardEl=this.container.querySelector("[data-id=board]"),this.boardEl.classList.add(e);for(let e=0;e<this.boardSize**2;e+=1){const a=document.createElement("div");a.classList.add("cell","map-tile","map-tile-"+(t=e,s=this.boardSize,0==t?"top-left":t>0&&t<s-1?"top":t==s-1?"top-right":t==s*s-s?"bottom-left":t==s*s-1?"bottom-right":t%s==0?"left":(t+1)%s==0?"right":t>s*s-s?"bottom":"center")),a.addEventListener("mouseenter",(e=>this.onCellEnter(e))),a.addEventListener("mouseleave",(e=>this.onCellLeave(e))),a.addEventListener("click",(e=>this.onCellClick(e))),this.boardEl.appendChild(a)}var t,s;this.cells=Array.from(this.boardEl.children)}redrawPositions(e){for(const e of this.cells)e.innerHTML="";for(const s of e){const e=this.boardEl.children[s.position],a=document.createElement("div");a.classList.add("character",s.character.type);const i=document.createElement("div");i.classList.add("health-level");const r=document.createElement("div");r.classList.add("health-level-indicator","health-level-indicator-"+((t=s.character.health)<15?"critical":t<50?"normal":"high")),r.style.width=`${s.character.health}%`,i.appendChild(r),a.appendChild(i),e.appendChild(a)}var t}addCellEnterListener(e){this.cellEnterListeners.push(e)}addCellLeaveListener(e){this.cellLeaveListeners.push(e)}addCellClickListener(e){this.cellClickListeners.push(e)}addNewGameListener(e){this.newGameListeners.push(e)}addSaveGameListener(e){this.saveGameListeners.push(e)}addLoadGameListener(e){this.loadGameListeners.push(e)}onCellEnter(e){e.preventDefault();const t=this.cells.indexOf(e.currentTarget);this.cellEnterListeners.forEach((e=>e.call(null,t)))}onCellLeave(e){e.preventDefault();const t=this.cells.indexOf(e.currentTarget);this.cellLeaveListeners.forEach((e=>e.call(null,t)))}onCellClick(e){const t=this.cells.indexOf(e.currentTarget);this.cellClickListeners.forEach((e=>e.call(null,t)))}onNewGameClick(e){e.preventDefault(),this.newGameListeners.forEach((e=>e.call(null)))}onSaveGameClick(e){e.preventDefault(),this.saveGameListeners.forEach((e=>e.call(null)))}onLoadGameClick(e){e.preventDefault(),this.loadGameListeners.forEach((e=>e.call(null)))}static showError(e){alert(e)}static showMessage(e){alert(e)}selectCell(e,t="yellow"){this.deselectCell(e),this.cells[e].classList.add("selected",`selected-${t}`)}deselectCell(e){const t=this.cells[e];t.classList.remove(...Array.from(t.classList).filter((e=>e.startsWith("selected"))))}showCellTooltip(e,t){this.cells[t].title=e}hideCellTooltip(e){this.cells[e].title=""}showDamage(e,t){return new Promise((s=>{const a=this.cells[e],i=document.createElement("span");i.textContent=t,i.classList.add("damage"),a.appendChild(i),i.addEventListener("animationend",(()=>{a.removeChild(i),s()}))}))}setCursor(e){this.boardEl.style.cursor=e}checkBinding(){if(null===this.container)throw new Error("GamePlay not bind to DOM")}}class t{constructor(e){this.characters=e}}function*s(e,t){const s=Math.floor(Math.random()*e.length),a=Math.floor(Math.random()*t)+1;yield new e[s](a)}function a(e,a,i){const r=[];for(let t=0;t<i;t++){const t=s(e,a);r.push(t.next().value)}return new t(r)}class i{constructor(e,t="generic"){if(new.target===i)throw new Error("–ó–∞–ø—Ä–µ—â–µ–Ω–æ —Å–æ–∑–¥–∞–≤–∞—Ç—å –æ–±—ä–µ–∫—Ç—ã –∫–ª–∞—Å—Å–∞ —á–µ—Ä–µ–∑ new Character");this.level=e,this.attack=0,this.defence=0,this.health=100,this.type=t}}class r extends i{constructor(e){super(e,"bowman"),this.attack=25,this.defence=25,this.attackRange=2,this.moveRange=2}}class h extends i{constructor(e){super(e,"swordsman"),this.attack=40,this.defence=10,this.attackRange=1,this.moveRange=4}}class o extends i{constructor(e){super(e,"magician"),this.attack=10,this.defence=40,this.attackRange=4,this.moveRange=1}}class n extends i{constructor(e){super(e,"vampire"),this.attack=25,this.defence=25,this.attackRange=2,this.moveRange=2}}class l extends i{constructor(e){super(e,"undead"),this.attack=40,this.defence=10,this.attackRange=1,this.moveRange=4}}class c extends i{constructor(e){super(e,"daemon"),this.attack=10,this.defence=10,this.attackRange=4,this.moveRange=1}}class d{constructor(e,t){if(!(e instanceof i))throw new Error("character must be instance of Character or its children");if("number"!=typeof t)throw new Error("position must be a number");this.character=e,this.position=t}}const m="auto",u="pointer",g="crosshair",v="not-allowed";class p{static from(e){return null}}const y=new e;y.bindToDOM(document.querySelector("#game-container"));const f=new class{constructor(e){this.storage=e}save(e){this.storage.setItem("state",JSON.stringify(e))}load(){try{return JSON.parse(this.storage.getItem("state"))}catch(e){throw new Error("Invalid state")}}}(localStorage),T=new class{constructor(e,t){this.gamePlay=e,this.stateService=t,this.positionUs=new Set,this.positionEnemy=new Set,this.permittedMoves=new Set,this.permittedAttacks=new Set,this.selected=-1,this.selectedExpected=-1,this.boardSize=e.boardSize,this.currentCharacter={},this.blockedBoard=!1,this.hits=0,this.gameState=new p,this.gameState.maxScore=0}init(){this.newGame(),this.gamePlay.addCellEnterListener(this.onCellEnter.bind(this)),this.gamePlay.addCellLeaveListener(this.onCellLeave.bind(this)),this.gamePlay.addCellClickListener(this.onCellClick.bind(this)),this.gamePlay.addNewGameListener(this.newGame.bind(this)),this.gamePlay.addSaveGameListener(this.saveGame.bind(this)),this.gamePlay.addLoadGameListener(this.loadGame.bind(this))}onCellClick(t){if(!this.blockedBoard)if(this.getPos(this.enemyTeam,t)>=0)if(this.selected>=0&&this.permittedAttacks.has(t)){let e=this.ourTeam[this.getPos(this.ourTeam,this.selected)].character,s=this.enemyTeam[this.getPos(this.enemyTeam,t)].character;this.attack(e,s,t).then((()=>{this.enemyMove()}))}else this.selected>=0?e.showError("–í—Ä–∞–≥ –≤–Ω–µ –¥–æ—Å—è–≥–∞–µ–º–æ—Å—Ç–∏"):e.showError("–ù–µ–ª—å–∑—è –≤—ã–±—Ä–∞—Ç—å —Ñ–∏–≥—É—Ä—É –≤—Ä–∞–≥–∞");else if(this.getPos(this.ourTeam,t)>=0){this.selected>=0&&(this.gamePlay.deselectCell(this.selected),this.permittedMoves.clear(),this.permittedAttacks.clear()),this.selected=t,this.gamePlay.selectCell(t);let e=this.getPos(this.ourTeam,t);this.currentCharacter=this.ourTeam[e].character,this.permittedMoves=this.getPermittedArea(this.currentCharacter.moveRange,t),this.permittedAttacks=this.getPermittedAttack(this.currentCharacter.attackRange,t)}else this.selected>=0&&this.permittedMoves.has(t)&&(this.moveCharacter(t,this.selected,"we"),this.enemyMove())}onCellEnter(e){this.selectedExpected>=0&&this.gamePlay.deselectCell(this.selectedExpected),this.gamePlay.setCursor(m);let t=this.getPos(this.ourTeam.concat(this.enemyTeam),e);if(-1!=t){let s=this.ourTeam.concat(this.enemyTeam)[t].character;this.gamePlay.showCellTooltip(this.showCellTooltipText(s),e),this.getPos(this.ourTeam,e)>=0?this.gamePlay.setCursor(u):this.getPos(this.enemyTeam,e)>=0&&(this.permittedAttacks.has(e)?(this.gamePlay.setCursor(g),this.gamePlay.selectCell(e,"red"),this.selectedExpected=e):this.gamePlay.setCursor(v))}else this.permittedMoves.has(e)?(this.gamePlay.setCursor(u),this.gamePlay.selectCell(e,"green"),this.selectedExpected=e):this.gamePlay.setCursor(v)}onCellLeave(e){this.gamePlay.hideCellTooltip(e)}getPosition(e){let t,s;if(1===e)for(s=this.positionUs.size;this.positionUs.size===s;)t=Math.floor(Math.random()*this.boardSize*2),t=Math.floor(t/2)*this.boardSize+t%2,this.positionUs.add(t);else for(s=this.positionEnemy.size;this.positionEnemy.size===s;)t=Math.floor(Math.random()*this.boardSize*2),t=(Math.floor(t/2)+1)*this.boardSize-1-t%2,this.positionEnemy.add(t);return t}showCellTooltipText(e){return"üéñ"+e.level+"‚öî"+e.attack+"üõ°"+e.defence+"‚ù§"+e.health}getPermittedArea(e,t){const s=new Set;let a;for(let i=1;i<=e;i+=1)for(let e=-1;e<=1;e+=2)a=t-this.boardSize*i*e,this.newPosCorrect(a,t,t-this.boardSize*i*e)&&s.add(a),a=t+i*e,this.newPosCorrect(a,t,t+i*e)&&s.add(a),a=t-this.boardSize*i+i*e,this.newPosCorrect(a,t,t-this.boardSize*i)&&s.add(a),a=t+this.boardSize*i+i*e,this.newPosCorrect(a,t,t+this.boardSize*i)&&s.add(a);return s}newPosCorrect(e,t,s){return e>=0&&e<this.boardSize*this.boardSize&&e!=t&&e>=this.boardSize*Math.floor(s/this.boardSize)&&e<this.boardSize*(Math.floor(s/this.boardSize)+1)}getPermittedAttack(e,t){const s=new Set;let a;for(let i=-e;i<=e;i+=1)for(let r=-e;r<=e;r+=1)a=t+this.boardSize*i+r,this.newPosCorrect(a,t,t+this.boardSize*i)&&s.add(a);return s}enemyMove(){if(0===this.enemyTeam.length||0===this.ourTeam.length)return;let e,t,s,a,i,r,h=!1;if(this.enemyTeam.forEach((e=>{h||(s=this.getPermittedAttack(e.character.attackRange,e.position),this.ourTeam.forEach((t=>{s.has(t.position)&&!h&&(this.attack(e.character,t.character,t.position,e.position),h=!0)})))})),h)return;let o=[];this.enemyTeam.forEach((t=>{e=t.character,this.ourTeam.forEach((s=>{i=(Math.abs(this.getColumn(t.position)-this.getColumn(s.position))+Math.abs(this.getRow(t.position)-this.getRow(s.position)))/(e.moveRange+e.attackRange+e.attack),o.push({en:t,tg:s,distance:i})}))})),o.sort(((e,t)=>e.distance-t.distance)),e=o[0].en.character,t=o[0].en.position,a=o[0].tg.position;let n,l=this.getRow(t),c=this.getRow(a);if(l<c&&!h)for(n=l+e.moveRange<c?e.moveRange:c-l;n>=0;)r=t+n*this.boardSize,-1!==this.getPos(this.ourTeam.concat(this.enemyTeam),r)||h||(this.moveCharacter(r,t,"enemy"),h=!0),n--;else if(l>c&&!h)for(n=l-e.moveRange>c?e.moveRange:-c+l;n>=0;)r=t-n*this.boardSize,-1!==this.getPos(this.ourTeam.concat(this.enemyTeam),r)||h||(this.moveCharacter(r,t,"enemy"),h=!0),n--;let d,m=this.getColumn(t),u=this.getColumn(a);if(m<u&&!h)for(m+e.moveRange<u?n=e.moveRange:d=m-m;d>=0;)r=t+d,-1!==this.getPos(this.ourTeam.concat(this.enemyTeam),r)||h||(this.moveCharacter(r,t,"enemy"),h=!0),d--;else if(m>u&&!h)for(d=m-e.moveRange>u?e.moveRange:-u+m;d>=0;){if(r=t-d,-1===this.getPos(this.ourTeam.concat(this.enemyTeam),r)&&!h)return void this.moveCharacter(r,t,"enemy");d--}}attack(e,t,s,a=-1){return new Promise((i=>{let r=Math.max(e.attack-t.defence,.1*e.attack);this.getPos(this.enemyTeam,s)>=0?this.hits+=r:this.getPos(this.ourTeam,s)>=0&&this.gamePlay.selectCell(a,"red"),this.gamePlay.showDamage(s,r).then((()=>{if(t.health=Math.max(t.health-r,0),0===t.health){if(this.getPos(this.ourTeam,s)>=0){let e=this.getPos(this.ourTeam,s);this.ourTeam.splice(e,1),this.selected===s&&(this.gamePlay.deselectCell(s),this.selected=-1,this.permittedMoves.clear(),this.permittedAttacks.clear(),-1!=this.selectedExpected&&(this.gamePlay.deselectCell(this.selectedExpected),this.selectedExpected=-1))}else{let e=this.getPos(this.enemyTeam,s);this.enemyTeam.splice(e,1)}this.levelUp()}-1!=a&&this.gamePlay.deselectCell(a),this.gamePlay.redrawPositions([...this.ourTeam,...this.enemyTeam]),i()}))}))}getRow(e){return Math.floor(e/this.boardSize)}getColumn(e){return e%this.boardSize}moveCharacter(e,t=-1,s){"enemy"===s?new Promise((s=>{this.blockedBoard=!0,setTimeout((()=>{this.gamePlay.selectCell(t,"red"),setTimeout((()=>{this.gamePlay.selectCell(e,"red"),setTimeout((()=>{this.enemyTeam[this.getPos(this.enemyTeam,t)].position=e,this.gamePlay.redrawPositions([...this.ourTeam,...this.enemyTeam]),s()}),300)}),300)}),300)})).then((()=>{this.gamePlay.deselectCell(t),this.gamePlay.deselectCell(e),this.blockedBoard=!1})):(this.ourTeam[this.getPos(this.ourTeam,this.selected)].position=e,this.gamePlay.deselectCell(this.selected),this.selected=e,this.gamePlay.selectCell(this.selected),this.permittedMoves=this.getPermittedArea(this.ourTeam[this.getPos(this.ourTeam,this.selected)].character.moveRange,e),this.permittedAttacks=this.getPermittedAttack(this.ourTeam[this.getPos(this.ourTeam,this.selected)].character.attackRange,e),this.selectedExpected=-1,this.gamePlay.redrawPositions([...this.ourTeam,...this.enemyTeam]))}levelUp(){0===this.ourTeam.length&&(e.showMessage("–ü–æ—Ä–∞–∂–µ–Ω–∏–µ! –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –æ—á–∫–æ–≤ "+this.hits),this.blockedBoard=!0),0===this.enemyTeam.length&&(this.currentLevel<4?(this.currentLevel+=1,this.positionEnemy.clear(),this.positionUs.clear(),this.ourTeam.forEach((e=>{e.character.attack=Math.round(Math.max(e.character.attack,e.character.attack*(80+e.character.health)/100)),e.character.defence=Math.round(Math.max(e.character.defence,e.character.defence*(80+e.character.health)/100)),e.character.health=Math.min(e.character.health+80,100),e.character.level+=1})),a([c,l,n],this.currentLevel,3).characters.forEach((e=>this.enemyTeam.push(new d(e,this.getPosition(2))))),this.gamePlay.redrawPositions([...this.ourTeam,...this.enemyTeam]),this.gamePlay.drawUi(this.geThemes(this.currentLevel))):(e.showMessage("–ü–æ–±–µ–¥–∞! –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –æ—á–∫–æ–≤ "+this.hits),this.blockedBoard=!0))}geThemes(e){switch(e){case 2:return"desert";case 3:return"arctic";case 4:return"mountain";default:return"prairie"}}getPos(e,t){return e.findIndex((e=>e.position===t))}newGame(){this.gameState.maxScore=Math.max(this.gameState.maxScore,this.hits),this.currentLevel=1,this.gamePlay.drawUi(this.geThemes(this.currentLevel));const t=a([r,h,o],1,1);this.ourTeam=[],t.characters.forEach((e=>this.ourTeam.push(new d(e,this.getPosition(1)))));const s=a([c,l,n],1,1);this.enemyTeam=[],s.characters.forEach((e=>this.enemyTeam.push(new d(e,this.getPosition(2))))),this.gamePlay.redrawPositions([...this.ourTeam,...this.enemyTeam]),this.blockedBoard=!1,this.hits=0,0!=this.gameState.maxScore&&e.showMessage("–ú–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –æ—á–∫–æ–≤ "+this.gameState.maxScore)}saveGame(){const t={hits:this.hits,maxScore:this.gameState.maxScore,level:this.currentLevel,ourTeam:this.ourTeam,enemyTeam:this.enemyTeam};this.stateService.save(t),e.showMessage("–ò–≥—Ä–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞!")}loadGame(){try{const t=this.stateService.load();t&&(this.hits=t.hits,this.currentLevel=t.level,this.ourTeam=t.ourTeam,this.enemyTeam=t.enemyTeam,this.gameState.maxScore=t.maxScore,this.gamePlay.drawUi(this.geThemes(this.currentLevel)),this.gamePlay.redrawPositions([...this.ourTeam,...this.enemyTeam]),this.blockedBoard=!1,e.showMessage("–ò–≥—Ä–∞ –∑–∞–≥—Ä—É–∂–µ–Ω–∞!"))}catch(t){e.showError(t),this.newGame()}}}(y,f);T.init()})();